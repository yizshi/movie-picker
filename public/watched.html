<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watched - Movie Picker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container py-4">
    <a href="/results.html" class="btn btn-link">← Back to results</a>
    <h1 class="mb-3">Watched movie</h1>

    <div id="watched-area">
      <div id="movie-card" class="mb-4"></div>

      <h4>Community score</h4>
      <div id="average-score" class="mb-3 text-muted">Loading average...</div>

      <h5>Leave a score & comment</h5>
      <form id="review-form" class="mb-4">
        <div class="mb-2">
          <label class="form-label">Your name</label>
          <input type="text" id="review-name" class="form-control" placeholder="Name (optional)">
        </div>
        <div class="mb-2">
          <label class="form-label">Score (0-10)</label>
          <input type="number" id="review-score" class="form-control" min="0" max="10" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Comment</label>
          <textarea id="review-comment" class="form-control" rows="3" placeholder="Share your thoughts (optional)"></textarea>
        </div>
        <button class="btn btn-primary" type="submit">Submit review</button>
        <div id="review-msg" class="mt-2"></div>
      </form>

      <h5>Comments</h5>
      <div id="reviews-list"></div>
    </div>
  </div>

  <script>
    // Read meetingId from query param, or fallback to none
    function qs(name) { const u = new URL(window.location.href); return u.searchParams.get(name); }
    const meetingId = qs('meetingId');

    async function fetchMeeting(id) {
      const res = await fetch(`/api/meetings/${id}`); return await res.json();
    }
    async function fetchReviews(movieId) {
      const res = await fetch(`/api/movies/${movieId}/reviews`); return await res.json();
    }
    async function postReview(movieId, body) {
      const res = await fetch(`/api/movies/${movieId}/reviews`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }); return await res.json();
    }

    async function render() {
      const area = document.getElementById('watched-area');
      if (!meetingId) { area.innerHTML = '<div class="text-muted">No meeting specified.</div>'; return; }
      try {
        const meeting = await fetchMeeting(meetingId);
        if (!meeting) { area.innerHTML = '<div class="text-muted">Meeting not found.</div>'; return; }
        if (!meeting.watched_movie) { area.innerHTML = '<div class="text-muted">No watched movie recorded for this meeting.</div>'; return; }
        const mv = meeting.watched_movie;
        const card = `\n          <div class="card flex-row">\n            <div style=\"padding:0.5rem\">\n              <img src=\"${mv.poster || 'https://via.placeholder.com/240x360?text=No+Poster'}\" alt=\"${mv.title}\" width=\"160\" height=\"240\" style=\"object-fit:cover\" />\n            </div>\n            <div class=\"card-body\">\n              <h3 class=\"card-title\">${mv.title}</h3>\n              <p class=\"card-text\">${mv.notes || ''}</p>\n              <div class=\"text-muted\">Suggested by: ${mv.suggester || 'Anonymous'}</div>\n            </div>\n          </div>\n        `;
        document.getElementById('movie-card').innerHTML = card;

        // wire the Open watched page link on results to this page if present
        const goto = document.getElementById('goto-watched-page');
        if (goto) goto.href = `/watched.html?meetingId=${meetingId}`;

        // load reviews
        const data = await fetchReviews(mv.id);
        document.getElementById('average-score').textContent = data.average !== null ? `Average: ${data.average} (${data.count} votes)` : 'No scores yet';
        const list = document.getElementById('reviews-list'); list.innerHTML = '';
        if (data.reviews && data.reviews.length) {
          for (const r of data.reviews) {
            const el = document.createElement('div'); el.className = 'card mb-2';
            el.innerHTML = `<div class=\"card-body\"><h6 class=\"card-subtitle mb-1 text-muted\">${r.username || 'Anonymous'} — ${new Date(r.created_at).toLocaleString()}</h6><div class=\"fw-bold\">Score: ${r.score}</div><p class=\"card-text\">${r.comment || ''}</p></div>`;
            list.appendChild(el);
          }
        } else {
          list.innerHTML = '<div class="text-muted">No comments yet.</div>';
        }

        // form submit
        const form = document.getElementById('review-form');
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('review-name').value.trim();
          const score = Number(document.getElementById('review-score').value);
          const comment = document.getElementById('review-comment').value.trim();
          const msg = document.getElementById('review-msg'); msg.textContent = '';
          if (isNaN(score) || score < 0 || score > 10) { msg.textContent = 'Score must be 0-10'; return; }
          try {
            const res = await postReview(mv.id, { username: name || null, score, comment: comment || null });
            if (!res || res.error) throw new Error(res && res.error ? res.error : 'Failed');
            // refresh
            document.getElementById('review-name').value = '';
            document.getElementById('review-score').value = '';
            document.getElementById('review-comment').value = '';
            document.getElementById('average-score').textContent = res.average !== null ? `Average: ${res.average} (${res.count} votes)` : 'No scores yet';
            const list = document.getElementById('reviews-list');
            list.innerHTML = '';
            for (const r of res.reviews) {
              const el = document.createElement('div'); el.className = 'card mb-2';
              el.innerHTML = `<div class=\"card-body\"><h6 class=\"card-subtitle mb-1 text-muted\">${r.username || 'Anonymous'} — ${new Date(r.created_at).toLocaleString()}</h6><div class=\"fw-bold\">Score: ${r.score}</div><p class=\"card-text\">${r.comment || ''}</p></div>`;
              list.appendChild(el);
            }
            msg.textContent = 'Thanks for your review';
          } catch (err) {
            msg.textContent = err.message || 'Error submitting review';
          }
        });

      } catch (err) {
        area.innerHTML = '<div class="text-muted">Error loading watched movie.</div>';
      }
    }

    render();
  </script>
</body>
</html>
