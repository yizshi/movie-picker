<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Manager - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .movie-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .movie-card {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 1rem;
            position: relative;
        }
        .movie-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 4px;
        }
        .movie-card h3 {
            margin: 0.5rem 0;
        }
        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
        }
        .delete-btn:hover {
            background: #cc0000;
        }
        .auth-section {
            padding: 1rem;
            background: #f5f5f5;
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Movie Manager</h1>
            <div>
                <a href="/" class="btn btn-outline-secondary me-2">Home</a>
                <button onclick="logout()" id="logoutBtn" class="btn btn-outline-danger d-none">Logout</button>
            </div>
        </div>
        <div class="auth-section" id="loginSection">
            <h2>Admin Login</h2>
            <div class="input-group mb-3">
                <input type="password" id="passwordInput" class="form-control" placeholder="Enter admin password">
                <button onclick="login()" class="btn btn-primary">Login</button>
            </div>
        </div>
        <div id="movieSection" class="hidden">
            <div class="movie-list" id="movieList">
                <!-- Movies will be loaded here -->
            </div>
        </div>
    </div>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        let adminToken = localStorage.getItem('adminToken');
        const loginSection = document.getElementById('loginSection');
        const movieSection = document.getElementById('movieSection');
        const movieList = document.getElementById('movieList');

        // Check if admin is logged in
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/admin/me', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
                const data = await response.json();
                if (data.admin) {
                    showAdminUI();
                    loadMovies();
                } else {
                    hideAdminUI();
                }
            } catch (err) {
                hideAdminUI();
            }
        }

        // Login function
        async function login() {
            const password = document.getElementById('passwordInput').value;
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password })
                });
                const data = await response.json();
                if (data.token) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    document.getElementById('passwordInput').value = '';
                    showAdminUI();
                    loadMovies();
                } else {
                    alert('Invalid password');
                }
            } catch (err) {
                alert('Login failed');
            }
        }

        // Logout function
        async function logout() {
            try {
                await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`
                    }
                });
            } catch (err) {
            }
            adminToken = null;
            localStorage.removeItem('adminToken');
            hideAdminUI();
        }

        // UI helper functions
        function showAdminUI() {
            loginSection.classList.add('hidden');
            movieSection.classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('d-none');
        }

        function hideAdminUI() {
            loginSection.classList.remove('hidden');
            movieSection.classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('d-none');
            adminToken = null;
            localStorage.removeItem('adminToken');
        }

        // Load all movies
        async function loadMovies() {
            try {
                const response = await fetch('/api/movies');
                const movies = await response.json();
                movieList.innerHTML = movies.map(movie => `
                    <div class="movie-card">
                        <img src="${movie.poster || 'placeholder.jpg'}" alt="${movie.title}">
                        <h3>${movie.title}</h3>
                        <p>Suggested by: ${movie.suggester || 'Anonymous'}</p>
                        <p>${movie.notes || ''}</p>
                        <button class="delete-btn" onclick="deleteMovie('${movie.id}')">Delete</button>
                    </div>
                `).join('');
            } catch (err) {
            }
        }

        // Delete a movie
        async function deleteMovie(id) {
            if (!confirm('Are you sure you want to delete this movie?')) {
                return;
            }

            if (!adminToken) {
                alert('You must be logged in as admin to delete movies');
                hideAdminUI();
                return;
            }

            try {
                const response = await fetch(`/api/movies/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'X-Admin-Token': adminToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                }
                
                if (response.ok) {
                    loadMovies(); // Reload the list
                } else {
                    
                    if (response.status === 401) {
                        alert('Your admin session has expired. Please log in again.');
                        hideAdminUI();
                    } else {
                        alert(data?.error || 'Failed to delete movie');
                    }
                }
            } catch (err) {
                alert('Error deleting movie. Please check if you are still logged in.');
                checkAdminStatus();
            }
        }

        // Check admin status when page loads
        checkAdminStatus();
    </script>
</body>
</html>